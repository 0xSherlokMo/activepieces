<form [formGroup]="form" class="ap-flex ap-flex-col">
  @for (
    property of sortedPropertiesByRequired | objectToArray;
    track property.key
  ) {
    <div class="ap-flex ap-justify-end ap-px-1 ap-mb-1">
      <app-dynamic-input-toggle-control
        [selected]="!!customizedInputs[property.key]"
        (valueChanged)="
          toggleCustomizedInput(property.value, property.key + '', $event)
        "
      ></app-dynamic-input-toggle-control>
    </div>

    @if (
      customizedInputs[property.key] ||
      property.value.type === PropertyType.SHORT_TEXT ||
      property.value.type === PropertyType.LONG_TEXT ||
      property.value.type === PropertyType.DATE_TIME ||
      property.value.type === PropertyType.FILE ||
      property.value.type === PropertyType.NUMBER
    ) {
      <app-text-control
        [passedFormControl]="
          form.controls[property.key] | abstractFormControlCaster
        "
        [property]="property.value"
      ></app-text-control>
    } @else if (
      property.value.type === PropertyType.STATIC_DROPDOWN ||
      property.value.type === PropertyType.STATIC_MULTI_SELECT_DROPDOWN
    ) {
      <app-static-dropdown-control
        [passedFormControl]="
          form.controls[property.key] | abstractFormControlCaster
        "
        [property]="property.value"
      ></app-static-dropdown-control>
    } @else if (
      property.value.type === PropertyType.DROPDOWN ||
      property.value.type === PropertyType.MULTI_SELECT_DROPDOWN
    ) {
      <app-refreshable-dropdown-control
        [passedFormControl]="
          form.controls[property.key] | abstractFormControlCaster
        "
        [flow]="flow"
        [parentFormGroup]="form"
        [actionOrTriggerName]="actionOrTriggerName"
        [pieceMetaData]="pieceMetaData"
        [propertyName]="property.key + ''"
        [property]="property.value"
      ></app-refreshable-dropdown-control>
    } @else if (
      property.value.type === PropertyType.OAUTH2 ||
      property.value.type === PropertyType.SECRET_TEXT ||
      property.value.type === PropertyType.BASIC_AUTH ||
      property.value.type === PropertyType.CUSTOM_AUTH
    ) {
      <app-connections-dropdown-control
        [passedFormControl]="
          form.controls[property.key] | abstractFormControlCaster
        "
        [options]="allConnectionsForPiece"
        [pieceMetaData]="pieceMetaData"
        [property]="property.value"
      ></app-connections-dropdown-control>
    } @else {
      @switch (property.value.type) {
        @case (PropertyType.CHECKBOX) {
          <app-checkbox-control
            [passedFormControl]="
              form.controls[property.key] | abstractFormControlCaster
            "
            [property]="property.value"
          ></app-checkbox-control>
        }
        @case (PropertyType.JSON) {
          <app-json-control
            [passedFormControl]="
              form.controls[property.key] | abstractFormControlCaster
            "
            [property]="property.value"
          ></app-json-control>
        }
        @case (PropertyType.MARKDOWN) {
          @if (property.value.description) {
            <ap-markdown
              [data]="
                property.value.description
                  | replaceMarkdownConsts
                    : flow.id
                    : webhookPrefix
                    : formPieceTriggerPrefix
              "
            >
            </ap-markdown>
          }
        }
        @case (PropertyType.ARRAY) {
          <!-- <app-array-form-control [property]="property.value" [prefix]="">

                </app-array-form-control> -->
        }
        @case (PropertyType.OBJECT) {
          <app-dictonary-form-control
            [formControl]="
              form.controls[property.key] | abstractFormControlCaster
            "
          ></app-dictonary-form-control>
        }
      }
    }

    @if (property.value.type !== PropertyType.MARKDOWN) {
      <ap-control-description
        [errorMessage]="
          (form.controls[property.key]
            | abstractFormControlCaster
            | extractControlErrorMessage: property.value.displayName
            | async) || ''
        "
        [passedFormControl]="
          form.controls[property.key] | abstractFormControlCaster
        "
        [description]="property.value.description || ''"
      >
      </ap-control-description>
    }
  }
</form>

@if (emitNewChanges$ | async) {}
