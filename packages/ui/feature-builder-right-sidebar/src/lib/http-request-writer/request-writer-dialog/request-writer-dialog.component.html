<ap-dialog-title-template i18n
  >Http Request Copilot
  <!-- <span class="ap-typography-caption ap-text-primary ap-mt-1">BETA</span> -->
</ap-dialog-title-template>

<mat-dialog-content>
  <div class="ap-max-w-[40.625rem]">
    <mat-stepper linear #stepper>
      <mat-step
        [completed]="
          (receivedRequest$ | async) !== undefined &&
          (receivedRequest$ | async) !== ''
        "
        [editable]="false"
      >
        <ng-template matStepLabel>Generate From Reference</ng-template>
        <ng-container *ngTemplateOutlet="promptTemplate"></ng-container>
      </mat-step>
      <mat-step>
        <ng-template matStepLabel>Code Iteration</ng-template>
        <ng-container *ngTemplateOutlet="editTemplate"></ng-container>
      </mat-step>
    </mat-stepper>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <div class="ap-flex ap-gap-2.5">
    <ap-button btnColor="basic" mat-dialog-close btnSize="default" i18n>
      Close
    </ap-button>
    <ap-button
      *ngIf="
        (receivedRequest$ | async) === undefined ||
        (receivedRequest$ | async) === ''
      "
      cdkFocusInitial
      btnSize="default"
      btnColor="primary"
      (click)="prompt()"
      [loading]="loading$ | async | defaultFalse"
      i18n
    >
      Next
    </ap-button>
    <ap-button
      *ngIf="
        (receivedRequest$ | async) !== undefined &&
        (receivedRequest$ | async) !== ''
      "
      cdkFocusInitial
      btnSize="default"
      btnColor="primary"
      [disabled]="loading$ | async | defaultFalse"
      (click)="useGeneratedCode()"
      i18n
    >
      Use Generated Request
    </ap-button>
  </div>
</mat-dialog-actions>

<ng-template #promptTemplate>
  <div class="ap-typography-body-1 ap-text-description ap-mb-4" i18n>
    Let AI generate an HTTP request for this step.
  </div>
  <ng-container
    [ngTemplateOutlet]="promptFormTemplate"
    [ngTemplateOutletContext]="{
      reprompt: false
    }"
  ></ng-container>
</ng-template>

<ng-template #editTemplate>
  <div class="ap-typography-body-1 ap-text-description ap-mb-4" i18n>
    Here is the code our AI wrote for you. Ask for changes or use the code in
    your action.
  </div>
  <ng-template #codeResult>{{ receivedRequest$ | async | json }}</ng-template>
  <div class="ap-mb-4">
    <pre
      *ngIf="prisimFix === false"
      class="thin-scrollbars ap-text-sm ap-px-4 ap-py-2 !ap-bg-gray-card"
    ><code class="language-js"><ng-container *ngTemplateOutlet="codeResult"> </ng-container></code></pre>
    <pre
      *ngIf="prisimFix === true"
      class="thin-scrollbars ap-text-sm ap-px-4 ap-py-2 !ap-bg-gray-card"
    ><code class="language-js"><ng-container *ngTemplateOutlet="codeResult"> </ng-container></code></pre>
  </div>

  <ng-container
    [ngTemplateOutlet]="promptFormTemplate"
    [ngTemplateOutletContext]="{
      reprompt: true
    }"
  ></ng-container>
</ng-template>

<ng-container *ngIf="promptOperation$ | async"></ng-container>

<ng-template #promptFormTemplate let-reprompt="reprompt">
  <form
    class="ap-flex ap-flex-col ap-gap-2"
    [formGroup]="promptForm"
    (submit)="prompt()"
  >
    <div class="ap-flex ap-items-center ap-gap-2">
      <div class="smaller-input ap-flex ap-flex-col ap-gap-2 ap-flex-grow">
        <mat-form-field
          class="ap-w-full"
          appearance="outline"
          subscriptSizing="dynamic"
        >
          <mat-label i18n>
            {{ (receivedRequest$ | async) ? 'Request Adjustment' : 'Prompt' }}
          </mat-label>
          <textarea
            *ngIf="
              (receivedRequest$ | async) === undefined ||
              (receivedRequest$ | async) === ''
            "
            class="!ap-resize-none"
            cdkFocusInitial
            (keydown.enter)="$event.preventDefault(); $event.stopPropagation()"
            (keyup.enter)="prompt(reprompt)"
            [formControl]="promptForm.controls.prompt"
            matInput
            type="text"
            rows="4"
          ></textarea>

          <input
            *ngIf="receivedRequest$ | async"
            cdkFocusInitial
            (keydown.enter)="$event.preventDefault(); $event.stopPropagation()"
            (keyup.enter)="prompt(reprompt)"
            [formControl]="promptForm.controls.prompt"
            matInput
            type="text"
          />

          <mat-error *ngIf="promptForm.controls.prompt.invalid" i18n
            >Prompt is required
          </mat-error>
        </mat-form-field>

        <mat-form-field
          class="ap-w-full"
          appearance="outline"
          subscriptSizing="dynamic"
          *ngIf="
            (receivedRequest$ | async) === undefined ||
            (receivedRequest$ | async) === ''
          "
        >
          <mat-label i18n> Docs Reference </mat-label>
          <input
            *ngIf="
              (receivedRequest$ | async) === undefined ||
              (receivedRequest$ | async) === ''
            "
            class="!ap-resize-none"
            cdkFocusInitial
            (keydown.enter)="$event.preventDefault(); $event.stopPropagation()"
            (keyup.enter)="prompt(reprompt)"
            [formControl]="promptForm.controls.reference"
            matInput
            type="text"
            rows="4"
          />
        </mat-form-field>
      </div>
      <div *ngIf="receivedRequest$ | async">
        <ap-button
          btnColor="primary"
          btnStyle="stroked"
          btnSize="large"
          [disabled]="!promptForm.controls.prompt.value"
          [loading]="loading$ | async | defaultFalse"
          [darkLoadingSpinner]="true"
          i18n
          >Ask</ap-button
        >
      </div>
    </div>
  </form>
</ng-template>
